<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 钱包转账 Demo - Ethers.js v6</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>🦊 Web3 Wallet</h1>
            </div>
            
            <!-- 钱包信息区 -->
            <div class="wallet-controls">
                <button id="connectBtn" class="btn btn-primary" type="button">连接 MetaMask</button>
                
                <div id="walletSection" class="wallet-section" style="display: none;">
                    <!-- 网络切换 -->
                    <div class="network-selector">
                        <label for="networkSwitch">🌐</label>
                        <select id="networkSwitch" class="network-select">
                            <option value="1">Ethereum Mainnet</option>
                            <option value="11155111">Sepolia Testnet</option>
                            <option value="137">Polygon Mainnet</option>
                            <option value="56">BSC Mainnet</option>
                        </select>
                    </div>
                    
                    <!-- 钱包地址显示 -->
                    <div class="wallet-display">
                        <div class="wallet-info-compact">
                            <span class="network-badge" id="currentNetwork">Ethereum</span>
                            <span class="wallet-address" id="walletAddress">0x0000...0000</span>
                        </div>
                        <button id="disconnectBtn" class="btn btn-disconnect" type="button">断开</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 钱包详细信息 -->
        <div id="walletInfo" class="section wallet-details" style="display: none;">
            <h2>💼 钱包信息</h2>
            <div class="info-grid">
                <div class="info-item">
                    <label>地址:</label>
                    <div class="info-value">
                        <span id="fullAddress">-</span>
                        <button id="copyAddressBtn" class="btn-icon" title="复制地址" type="button">📋</button>
                    </div>
                </div>
                <div class="info-item">
                    <label>余额:</label>
                    <span class="info-value"><span id="balance">0</span> ETH</span>
                </div>
                <div class="info-item">
                    <label>网络:</label>
                    <span class="info-value" id="networkName">-</span>
                </div>
                <div class="info-item">
                    <label>Chain ID:</label>
                    <span class="info-value" id="chainId">-</span>
                </div>
            </div>
        </div>

        <!-- 转账功能区域 - Tab 切换 -->
        <div id="transferSection" class="section">
            <h2>💸 转账功能</h2>

            <!-- Tab 导航 -->
            <div class="tab-navigation">
                <button type="button" class="tab-btn active" data-tab="direct">
                    📡 直接转账 (Ethers.js)
                </button>
                <button type="button" class="tab-btn" data-tab="contract">
                    🏦 合约转账 (The Graph)
                </button>
            </div>

            <!-- Tab 1: 直接转账 -->
            <div id="directTab" class="tab-content active">
                <div class="tab-description">
                    <p>💡 使用 Ethers.js 直接在区块链上发送加密转账，支持附带加密消息</p>
                </div>

                <!-- 转账表单 -->
                <div class="form-container">
                    <div class="form-group">
                        <label for="recipientAddress">接收地址:</label>
                        <input type="text" id="recipientAddress" placeholder="0x..." class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="amount">转账金额 (ETH):</label>
                        <input type="number" id="amount" step="0.001" placeholder="0.01" class="input-field">
                    </div>
                    <div class="form-group">
                        <label for="message">消息 (将被加密为16进制):</label>
                        <input type="text" id="message" placeholder="转账备注信息" class="input-field">
                        <small>💡 此消息将使用 XOR 加密并转换为16进制数据存储在链上</small>
                    </div>
                    <button type="button" id="sendBtn" class="btn btn-success btn-large" disabled>
                        <span>🚀 发送交易</span>
                    </button>
                    <div id="txStatus" class="status-box"></div>
                </div>

                <!-- 直接转账历史 -->
                <div class="history-section">
                    <div class="history-header">
                        <h3>📜 交易历史</h3>
                        <button type="button" id="fetchDirectBtn" class="btn btn-info" disabled>
                            🔄 查询交易
                        </button>
                    </div>
                    <div class="data-source-indicator">
                        <span>数据来源: <strong>Ethers.js - 直接从区块链查询</strong></span>
                    </div>
                    <div id="directTxHistory" class="tx-history">
                        <div class="no-data"><p>💡 请先连接钱包并进行转账，然后点击"查询交易"按钮</p></div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 合约转账 -->
            <div id="contractTab" class="tab-content">
                <div class="tab-description">
                    <p>💡 通过 WalletTransfer 合约进行转账，使用 The Graph 查询历史记录</p>
                </div>

                <!-- 合约信息 -->
                <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 12px 15px; margin-bottom: 20px; border-radius: 8px;">
                    <p style="color: rgba(0,0,0, 0.9); font-size: 0.9em; margin: 0;">
                        💡 <strong>提示：</strong>如果合约地址不同，请在 <code>contract.js</code> 文件中修改 <code>contractAddress</code> 变量
                    </p>
                </div>

                <div class="contract-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <label>合约地址:</label>
                            <span class="info-value address" style="font-size: 0.85em;">0x5FbDB2315678afecb367f032d93F642f64180aa3</span>
                        </div>
                        <div class="info-item">
                            <label>您在合约中的余额:</label>
                            <span class="info-value">
                                <span id="contractUserBalance">-</span> ETH
                                <button type="button" id="refreshContractBalanceBtn" class="btn-icon" title="刷新余额">🔄</button>
                            </span>
                        </div>
                        <div class="info-item">
                            <label>合约总余额:</label>
                            <span class="info-value"><span id="contractTotalBalance">-</span> ETH</span>
                        </div>
                    </div>
                </div>

                <!-- 合约操作 -->
                <div class="contract-operations">
                    <!-- 存入 ETH -->
                    <div class="operation-card">
                        <h3>📥 存入 ETH</h3>
                        <p>向合约存入 ETH，存入后您可以使用合约进行转账</p>
                        <div class="form-group">
                            <label for="contractDepositAmount">存入金额 (ETH):</label>
                            <input type="number" id="contractDepositAmount" step="0.001" placeholder="0.1" class="input-field">
                        </div>
                        <button type="button" id="contractDepositBtn" class="btn btn-info">💰 存入</button>
                    </div>

                    <!-- 合约内转账 -->
                    <div class="operation-card">
                        <h3>🔄 合约内转账</h3>
                        <p>使用您在合约中的余额向其他地址转账</p>
                        <div class="form-group">
                            <label for="contractTransferTo">接收地址:</label>
                            <input type="text" id="contractTransferTo" placeholder="0x..." class="input-field">
                        </div>
                        <div class="form-group">
                            <label for="contractTransferAmount">转账金额 (ETH):</label>
                            <input type="number" id="contractTransferAmount" step="0.001" placeholder="0.01" class="input-field">
                        </div>
                        <button type="button" id="contractTransferBtn" class="btn btn-primary">📤 转账</button>
                    </div>

                    <!-- 提取 ETH -->
                    <div class="operation-card">
                        <h3>📤 提取 ETH</h3>
                        <p>从合约中提取您的 ETH 到钱包</p>
                        <div class="form-group">
                            <label for="contractWithdrawAmount">提取金额 (ETH):</label>
                            <input type="number" id="contractWithdrawAmount" step="0.001" placeholder="0.05" class="input-field">
                        </div>
                        <button type="button" id="contractWithdrawBtn" class="btn btn-warning">💸 提取</button>
                    </div>
                </div>

                <div id="contractStatus" class="status-box"></div>

                <!-- 合约转账历史 -->
                <div class="history-section">
                    <div class="history-header">
                        <h3>📜 合约转账历史</h3>
                        <button type="button" id="fetchContractBtn" class="btn btn-warning" disabled>
                            🔄 查询 The Graph
                        </button>
                    </div>
                    <div class="data-source-indicator">
                        <span>数据来源: <strong>The Graph - 本地 wallet-transfer subgraph</strong></span>
                    </div>
                    <div id="contractTxHistory" class="tx-history">
                        <div class="no-data"><p>💡 请先连接钱包并通过合约转账，然后点击"查询 The Graph"按钮</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 加密/解密工具 -->
        <!-- <div class="section">
            <h2>🔐 加密/解密工具</h2>
            <div class="crypto-tools">
                <div class="tool-section">
                    <h3>加密工具</h3>
                    <div class="form-group">
                        <label for="plainText">明文:</label>
                        <textarea id="plainText" placeholder="输入要加密的文本" class="textarea-field" rows="3"></textarea>
                    </div>
                    <button id="encryptBtn" class="btn btn-secondary">🔒 加密为16进制</button>
                    <div class="form-group">
                        <label for="encryptedText">密文 (16进制):</label>
                        <textarea id="encryptedText" placeholder="加密后的16进制数据" class="textarea-field" rows="3" readonly></textarea>
                    </div>
                </div>
                
                <div class="tool-section">
                    <h3>解密工具</h3>
                    <div class="form-group">
                        <label for="hexToDecrypt">16进制密文:</label>
                        <textarea id="hexToDecrypt" placeholder="输入16进制密文 (可以包含0x前缀)" class="textarea-field" rows="3"></textarea>
                    </div>
                    <button id="decryptBtn" class="btn btn-secondary">🔓 解密</button>
                    <div class="form-group">
                        <label for="decryptedText">解密结果:</label>
                        <textarea id="decryptedText" placeholder="解密后的明文" class="textarea-field" rows="3" readonly></textarea>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- 功能说明 -->
        <div class="section info-section">
            <h2>📖 功能说明</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <h4>🔌 钱包连接</h4>
                    <p>连接 MetaMask 钱包，支持多网络切换</p>
                </div>
                <div class="feature-item">
                    <h4>🏦 合约操作</h4>
                    <p>通过 WalletTransfer 合约进行存入、转账和提取操作</p>
                </div>
                <div class="feature-item">
                    <h4>💰 加密转账</h4>
                    <p>发送 ETH 并附带加密消息，数据以16进制存储</p>
                </div>
                <div class="feature-item">
                    <h4>📊 双重查询</h4>
                    <p>使用 Ethers.js 或 The Graph 查询链上数据</p>
                </div>
                <div class="feature-item">
                    <h4>🔍 The Graph 集成</h4>
                    <p>连接本地 Graph Node，查询 wallet-transfer subgraph</p>
                </div>
                <div class="feature-item">
                    <h4>🔐 自动解密</h4>
                    <p>读取交易时自动解密16进制消息</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>Built with Ethers.js v6 | ⚠️ 仅供学习使用，请在测试网络上测试</p>
    </footer>

    <script type="module" src="app.js"></script>
</body>
</html>
